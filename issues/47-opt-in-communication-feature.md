# Feature Request: Opt-in Communication & DM Targeting System

**Type:** Feature  
**Status:** Proposed  
**Related:** #46 (Datetime Parsing Enhancement for Reminders)  
**Priority:** High

## Overview

Implement an opt-in system for users to explicitly consent to receiving direct messages (DMs) and using commands in the VeraBot communication suite. This ensures respectful communication practices and gives users control over their experience.

## Problem Statement

Currently, the VeraBot system (particularly the reminder system) can send direct messages to users without explicit consent. Users should have control over whether they receive DMs and communicate with VeraBot, and senders should be informed when a recipient hasn't opted in.

## Proposed Solution

Implement a role-based opt-in system where:

1. **User Opt-In**: Users can opt-in to receive DMs and use VeraBot commands via a `/opt-in` command
2. **Comm-Role Tracking**: Users who opt-in receive a "comm-role" that marks them as opted-in
3. **Opt-Out Option**: Users can opt-out at any time via an `/opt-out` command
4. **Sender Notifications**: When a sender attempts to use features that require opt-in (e.g., sending reminders), they're informed if the recipient hasn't opted in
5. **Graceful Degradation**: Features that depend on DMs should provide alternative feedback when the target user hasn't opted in

## User Experience Flow

### For Users Opting In
```
User: /opt-in
Bot: You've opted in to receive direct messages and use VeraBot commands.
     You now have access to all VeraBot communication features.
     Use /opt-out at any time to disable DMs.
```

### For Users Opting Out
```
User: /opt-out
Bot: You've opted out of direct messages.
     You can still use VeraBot commands in servers, but won't receive DMs.
     Use /opt-in to re-enable.
```

### For Senders with Opted-Out Recipients
```
User: /create-reminder subject:"Follow up" when:"tomorrow" who:@opted-out-user
Bot: ‚ö†Ô∏è  @opted-out-user hasn't opted in to receive direct messages.
     
     Options:
     ‚Ä¢ Cancel - Don't create this reminder
     ‚Ä¢ Create without DM - Reminder will only post in server
     ‚Ä¢ Notify User - Ask them to opt-in first
     
     What would you like to do? (React with ‚ùå Cancel, üìã Create, or üì¢ Notify)
```

**If sender chooses "Create without DM":**
```
Bot: Reminder created for @opted-out-user.
     They will receive a server message but NOT a DM.
     Reminder will be posted in #reminders channel at the scheduled time.
```

**If sender chooses "Notify User":**
```
Bot: Sent a message to @opted-out-user asking them to opt-in.
     Once they opt-in, you can create the reminder.
```

## Technical Requirements

### 1. Database Schema
Add to reminder system database:
```sql
CREATE TABLE IF NOT EXISTS user_communications (
  user_id TEXT PRIMARY KEY,
  opted_in BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2. Commands to Implement

#### `/opt-in`
- **Description:** Opt-in to receive DMs and use VeraBot communication features
- **Parameters:** None
- **Behavior:**
  - Adds user ID to `user_communications` table with `opted_in = true`
  - Assigns user the "comm-role" (or equivalent permission marker)
  - Confirms with success message
  - No error if already opted in (idempotent)

#### `/opt-out`
- **Description:** Opt-out of receiving DMs from VeraBot
- **Parameters:** None
- **Behavior:**
  - Updates user in `user_communications` table with `opted_in = false`
  - Removes "comm-role" from user
  - Confirms with warning message
  - No error if already opted out (idempotent)

#### `/comm-status` (Optional)
- **Description:** Check your current communication opt-in status
- **Parameters:** None
- **Behavior:**
  - Shows current opt-in status
  - Displays when user opted in/out
  - Explains what features are available

#### `/opt-in-request` (Generated by system)
- **Description:** Internal command - sent to opted-out users when sender requests them to opt-in
- **Parameters:** None (user receives as button in notification)
- **Behavior:**
  - User can opt-in directly from notification
  - Notifies original sender that user has opted-in
  - Allows sender to retry reminder creation

### 3. Service Layer Updates

Create `src/services/CommunicationService.js`:
```javascript
class CommunicationService {
  // Check if user has opted in
  async isOptedIn(userId) { }
  
  // Opt user in
  async optIn(userId) { }
  
  // Opt user out
  async optOut(userId) { }
  
  // Get user's communication status
  async getStatus(userId) { }
}
```

### 4. Reminder System Integration

Update `src/services/ReminderService.js` to:
- Check if reminder recipient has opted in before sending DM
- Return status information about opt-in state with action options
- Include helper text in DM warnings
- Support creating reminders in "server-only" mode (no DM)

Update `src/commands/reminder-management/create-reminder.js` to:
- Check recipient's opt-in status
- Display warning with **interactive buttons** if user hasn't opted in:
  - **‚ùå Cancel** - Abort reminder creation
  - **üìã Create** - Create reminder with server-only notifications
  - **üì¢ Notify** - Send opt-in request to recipient
- Store option to track reminder notification preference (DM vs server-only)
- Provide confirmation based on sender's choice

### 5. Response Helpers

Add to `src/utils/helpers/response-helpers.js`:
```javascript
async function sendOptInWarning(interaction, user) { }
async function sendOptOutSuccess(interaction) { }
async function sendOptInStatus(interaction, isOptedIn, timestamp) { }

// New for sender decision workflow
async function sendOptInChoicePrompt(interaction, recipient, reminderSubject) { }
  // Shows interactive buttons for Cancel/Create/Notify options
  
async function sendReminderCreatedServerOnly(interaction, recipient) { }
  // Confirms reminder created without DM
  
async function sendOptInRequest(user, sender, reminderSubject) { }
  // Sent to opted-out user requesting opt-in, includes direct opt-in button
```

## Acceptance Criteria

### Phase 1: Core Opt-In System
- [ ] Create `CommunicationService` with opt-in/out methods
- [ ] Add `user_communications` table to database schema
- [ ] Implement `/opt-in` command
- [ ] Implement `/opt-out` command
- [ ] Add response helpers for opt-in messages
- [ ] Unit tests for `CommunicationService` (minimum 10 tests)
- [ ] All existing tests still pass
- [ ] ESLint compliance

### Phase 2: Reminder Integration
- [ ] Update `ReminderService` to check opt-in status and support server-only mode
- [ ] Modify `create-reminder` command with interactive decision buttons:
  - [ ] Implement Cancel option (abort reminder)
  - [ ] Implement Create option (server-only notifications)
  - [ ] Implement Notify option (request user opt-in)
- [ ] Add `notification_method` field to reminders table ("dm" or "server")
- [ ] Update reminder DM to only send if opted-in
- [ ] Create server-only reminder notification system (channel/thread posting)
- [ ] Update `update-reminder` command with same decision flow
- [ ] Integration tests for all three decision paths (minimum 8 tests)
- [ ] All existing reminder tests still pass

### Phase 3: User Experience
- [ ] Implement `/comm-status` command (optional but recommended)
- [ ] Create `/opt-in-request` notification handler for sender's opt-in requests
- [ ] Add help command entries for new commands
- [ ] Document in user-facing documentation:
  - [ ] Explain opt-in system to users
  - [ ] Document sender decision flow
  - [ ] Show example workflows
- [ ] Consider onboarding message for new users explaining opt-in

### Phase 4: Additional Features (Future)
- [ ] Server-wide opt-in default settings (admins can require opt-in for server)
- [ ] Bulk opt-in/out management for server admins
- [ ] Communication preferences (choose which types of DMs to receive)
- [ ] Opt-in expiry after X days of inactivity
- [ ] Automatic reminder retry when recipient opts-in
- [ ] Sender opt-in status notifications ("User just opted-in! Retry reminder?")
- [ ] Reminder delivery history tracking

## Implementation Notes

### User Experience Considerations
- **Privacy First**: Users should always have explicit control
- **Clear Messaging**: Be transparent about what opting in means
- **Easy Reversal**: Make it simple to change preferences
- **Non-Blocking**: Don't prevent users from using server commands based on DM opt-in
- **Feedback**: Always confirm when settings change

### Database Considerations
- Keep `user_communications` table lightweight
- Use timestamps to track opt-in/out history
- Add `notification_method` column to reminders table (default: "dm", fallback: "server")
- Update reminders schema to store notification preference
- Consider adding migration script for existing users
- Plan for optional "last reminded" tracking for analytics
- Consider audit log for opt-in/out events

### Permission Model
- Users manage their own opt-in status
- Admins can view opt-in status for their server (future enhancement)
- No user should be forced to opt-in

### Testing Strategy
- Unit tests for `CommunicationService`
- Integration tests for reminder system with opted-out users
- Edge cases: users opting in/out during reminder processing
- Test both DM send success and failure scenarios

## Related Issues & PRs
- PR #46: Datetime Parsing Enhancement for Reminders (uses this feature)
- Issue #42: Reminder System (will integrate with this)

## Success Metrics

1. ‚úÖ All opt-in/out operations are idempotent
2. ‚úÖ Users can manage their communication preferences
3. ‚úÖ Senders are clearly informed about opt-in status
4. ‚úÖ No unwanted DMs sent to opted-out users
5. ‚úÖ 100% test coverage for new functionality
6. ‚úÖ 0 errors, minimal warnings from linter
7. ‚úÖ All existing features continue to work

## Future Enhancements

- Communication preference levels (all DMs, reminders only, server-only)
- Server-wide opt-in policies
- Daily summary digest instead of individual DMs
- Opt-in analytics and user engagement tracking
- Rate limiting for high-volume DM features

## Questions for Review

1. Should opted-out users still see server-posted reminders?
   - **Proposed:** Yes, server-posted reminders are always visible
   
2. Should admins be able to view opt-in status in their server?
   - **Proposed:** Yes, for moderation/support purposes (phase 4)
   
3. Should opt-in be server-specific or global?
   - **Proposed:** Global (user-wide setting) for simplicity
   
4. What's the default for new users (opt-in or opt-out)?
   - **Proposed:** Opt-out (privacy-first)
   
5. When sender uses "Notify" option, should reminder automatically retry?
   - **Proposed:** Manual retry recommended (future enhancement)
   
6. Should server-only reminders appear in a dedicated channel?
   - **Proposed:** Yes, dedicated #reminders or thread (configurable)
   
7. Should there be a cooldown on repeated opt-in requests?
   - **Proposed:** Yes, limit to 1 request per day per sender

---

**Created:** January 1, 2026  
**Updated:** January 1, 2026
