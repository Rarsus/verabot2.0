name: Deployment Approval Gates

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production

# Prevent concurrent deployments to same environment
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'manual' }}
  cancel-in-progress: false

permissions:
  contents: read
  deployments: write
  pull-requests: write

jobs:
  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Verify main branch
        if: github.ref != 'refs/heads/main'
        run: |
          echo "âŒ Deployments only allowed from main branch"
          exit 1

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ğŸ§ª Run all tests
        run: npm ci && npm test

      - name: ğŸ“Š Verify coverage
        run: npm run test:coverage

      - name: ğŸ” Run linting
        run: npm run lint

      - name: ğŸ” Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

  approval-review:
    name: Approval Review
    runs-on: ubuntu-latest
    needs: [validate-deployment]

    steps:
      - name: ğŸ“‹ Review deployment requirements
        run: |
          echo "ğŸš€ Deployment Approval Checklist"
          echo "=================================="
          echo ""
          echo "âœ… Tests passed"
          echo "âœ… Coverage verified"
          echo "âœ… Linting passed"
          echo "âœ… Security audit completed"
          echo ""
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"

      - name: ğŸ’¬ Request approval for production
        if: github.event.inputs.environment == 'production'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = `ğŸš€ **Production Deployment Approval Requested**

            **Environment:** Production
            **Triggered by:** @${{ github.actor }}
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}

            **Pre-deployment Checks:**
            âœ… All tests passed
            âœ… Coverage requirements met
            âœ… Code quality verified
            âœ… Security audit completed

            **Required Approvals:** 
            - At least 1 maintainer must approve
            - All critical security checks must pass

            **Deployment will proceed to:**
            - Staging environment (automatic)
            - Production environment (manual approval required)`;

            // Create issue for approval
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš€ Production Deployment Approval - ' + new Date().toISOString().split('T')[0],
              body: message,
              labels: ['deployment', 'approval-required']
            });
        continue-on-error: true

      - name: ğŸ“¤ Create deployment record
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: '${{ github.event.inputs.environment }}',
              required_contexts: [],
              auto_merge: false,
              description: 'Deployment initiated by ${{ github.actor }}'
            });

            console.log('Deployment created:', deployment.data.id);

            // Mark as success
            if (deployment.status === 201) {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.data.id,
                state: 'success',
                description: 'Ready for deployment',
                environment_url: 'https://example.com/' + '${{ github.event.inputs.environment }}'
              });
            }
        continue-on-error: true

  pre-deployment-notification:
    name: Pre-Deployment Notification
    runs-on: ubuntu-latest
    needs: [approval-review]
    if: github.event.inputs.environment == 'staging'

    steps:
      - name: ğŸ“¢ Notify team of staging deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const notification = `ğŸ¯ **Staging Deployment In Progress**

            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            **Triggered by:** @${{ github.actor }}
            **Timestamp:** ${new Date().toISOString()}

            **Deployment Steps:**
            1. âœ… Code validation completed
            2. â³ Building Docker image
            3. â³ Running smoke tests
            4. â³ Deploying to staging
            5. â³ Running integration tests

            **Monitoring:**
            - Check deployment logs for progress
            - Monitor error rates post-deployment
            - Run sanity checks`;

            console.log(notification);
        continue-on-error: true

  deployment-complete:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [validate-deployment, approval-review]
    if: always()

    steps:
      - name: âœ… Record deployment status
        run: |
          echo "ğŸ¯ Deployment Gate Complete"
          echo "============================"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Status: Ready for deployment"
          echo ""
          echo "Next Steps:"
          echo "1. Approve production deployment (if applicable)"
          echo "2. Monitor deployment logs"
          echo "3. Verify application health"
          echo "4. Monitor error rates and performance"

      - name: ğŸ’¬ Post deployment status
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = `âŒ **Deployment Validation Failed**

            Environment: ${{ github.event.inputs.environment }}
            Reason: Pre-deployment checks failed

            Please review the logs and fix any issues before attempting deployment again.`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âŒ Deployment Failed - ' + '${{ github.event.inputs.environment }}',
              body: message,
              labels: ['deployment', 'failed']
            });
        continue-on-error: true
