name: Type & Documentation Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM UTC

# Prevent duplicate runs
concurrency:
  group: type-check-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  jsdoc-validation:
    name: JSDoc Type Validation
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: üóÇÔ∏è Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-20-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-modules-20-

      - name: üìö Install dependencies
        run: npm ci

      - name: üîç Analyze JSDoc comments
        run: |
          echo "üìä JSDoc Analysis Results" > jsdoc-report.txt
          echo "==========================" >> jsdoc-report.txt
          echo "" >> jsdoc-report.txt
          
          # Count files with JSDoc
          echo "## Files with JSDoc Coverage:" >> jsdoc-report.txt
          find src -name "*.js" ! -name "*.test.js" ! -name "*.spec.js" | while read file; do
            if grep -q "/\*\*" "$file"; then
              echo "‚úÖ $file" >> jsdoc-report.txt
            else
              echo "‚ö†Ô∏è $file (missing JSDoc)" >> jsdoc-report.txt
            fi
          done
          
          echo "" >> jsdoc-report.txt
          echo "## JSDoc Coverage Summary:" >> jsdoc-report.txt
          
          total=$(find src -name "*.js" ! -name "*.test.js" ! -name "*.spec.js" | wc -l)
          documented=$(find src -name "*.js" ! -name "*.test.js" ! -name "*.spec.js" -exec grep -l "/\*\*" {} \; | wc -l)
          coverage=$(echo "scale=2; ($documented * 100) / $total" | bc)
          
          echo "Total files: $total" >> jsdoc-report.txt
          echo "Documented files: $documented" >> jsdoc-report.txt
          echo "Coverage: ${coverage}%" >> jsdoc-report.txt

      - name: üìÅ Upload JSDoc report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jsdoc-report
          path: jsdoc-report.txt
          retention-days: 30

  typescript-check:
    name: TypeScript Type Checking
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: üóÇÔ∏è Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-20-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-modules-20-

      - name: üìö Install dependencies
        run: npm ci

      - name: üîç Check with JSDoc type annotations
        run: |
          echo "üìä JSDoc Type Check Results" > type-check-report.txt
          echo "===========================" >> type-check-report.txt
          echo "" >> type-check-report.txt
          
          # Check for common type annotation patterns
          echo "## Type Annotation Audit:" >> type-check-report.txt
          echo "" >> type-check-report.txt
          
          # Count @param annotations
          params=$(find src -name "*.js" ! -name "*.test.js" ! -name "*.spec.js" -exec grep -c "@param" {} \; | awk '{s+=$1} END {print s}')
          echo "Total @param annotations: $params" >> type-check-report.txt
          
          # Count @returns annotations
          returns=$(find src -name "*.js" ! -name "*.test.js" ! -name "*.spec.js" -exec grep -c "@returns" {} \; | awk '{s+=$1} END {print s}')
          echo "Total @returns annotations: $returns" >> type-check-report.txt
          
          # Count @typedef annotations
          typedefs=$(find src -name "*.js" ! -name "*.test.js" ! -name "*.spec.js" -exec grep -c "@typedef" {} \; | awk '{s+=$1} END {print s}')
          echo "Total @typedef annotations: $typedefs" >> type-check-report.txt
          
          echo "" >> type-check-report.txt
          echo "## Files Needing Type Documentation:" >> type-check-report.txt
          
          # List functions without @param/@returns
          find src -name "*.js" ! -name "*.test.js" ! -name "*.spec.js" | while read file; do
            # Simple regex to find function definitions
            functions=$(grep -c "^\(async \|function \)" "$file" || true)
            jsdocs=$(grep -c "/\*\*" "$file" || true)
            
            if [ "$functions" -gt 0 ] && [ "$jsdocs" -eq 0 ]; then
              echo "‚ö†Ô∏è $file ($functions functions, no JSDoc)" >> type-check-report.txt
            fi
          done
          
          echo "" >> type-check-report.txt
          echo "## Recommendations:" >> type-check-report.txt
          echo "- Add @param and @returns to all public functions" >> type-check-report.txt
          echo "- Use @typedef for complex object types" >> type-check-report.txt
          echo "- Document exceptions with @throws" >> type-check-report.txt
          echo "- Use @async for async functions" >> type-check-report.txt

      - name: üìÅ Upload type check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: type-check-report
          path: type-check-report.txt
          retention-days: 30

  documentation-completeness:
    name: Documentation Completeness
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üìö Check documentation completeness
        run: |
          echo "üìñ Documentation Completeness Report" > docs-report.txt
          echo "=====================================" >> docs-report.txt
          echo "" >> docs-report.txt
          
          # Check for critical documentation files
          echo "## Critical Documentation Files:" >> docs-report.txt
          
          [ -f "README.md" ] && echo "‚úÖ README.md" >> docs-report.txt || echo "‚ùå README.md" >> docs-report.txt
          [ -f "CONTRIBUTING.md" ] && echo "‚úÖ CONTRIBUTING.md" >> docs-report.txt || echo "‚ùå CONTRIBUTING.md" >> docs-report.txt
          [ -f "CODE_OF_CONDUCT.md" ] && echo "‚úÖ CODE_OF_CONDUCT.md" >> docs-report.txt || echo "‚ùå CODE_OF_CONDUCT.md" >> docs-report.txt
          [ -f "CHANGELOG.md" ] && echo "‚úÖ CHANGELOG.md" >> docs-report.txt || echo "‚ùå CHANGELOG.md" >> docs-report.txt
          [ -d "docs/" ] && echo "‚úÖ docs/ directory" >> docs-report.txt || echo "‚ùå docs/ directory" >> docs-report.txt
          
          echo "" >> docs-report.txt
          echo "## Module Documentation:" >> docs-report.txt
          
          # Check if main modules have documentation
          for dir in src/commands src/services src/core src/middleware src/utils; do
            if [ -d "$dir" ]; then
              count=$(ls -1 "$dir"/*.js 2>/dev/null | grep -v test | grep -v spec | wc -l)
              echo "üìÅ $dir: $count modules" >> docs-report.txt
            fi
          done
          
          echo "" >> docs-report.txt
          echo "## API Documentation Status:" >> docs-report.txt
          echo "Target: 100% of public APIs documented" >> docs-report.txt
          echo "Current: Review jsdoc-report.txt for details" >> docs-report.txt

      - name: üìÅ Upload documentation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentation-report
          path: docs-report.txt
          retention-days: 30

  validation-summary:
    name: Type & Documentation Summary
    runs-on: ubuntu-latest
    needs: [jsdoc-validation, typescript-check, documentation-completeness]
    if: always()

    steps:
      - name: üìä Validation Summary
        run: |
          echo "‚úÖ Type and Documentation Validation Complete"
          echo "=============================================="
          echo ""
          echo "Checks performed:"
          echo "  ‚úÖ JSDoc comment analysis"
          echo "  ‚úÖ Type annotation audit"
          echo "  ‚úÖ Documentation completeness"
          echo ""
          echo "Next steps:"
          echo "  1. Review JSDoc report (artifacts)"
          echo "  2. Review type check report (artifacts)"
          echo "  3. Review documentation report (artifacts)"
          echo "  4. Add missing documentation"
          echo "  5. Ensure all public APIs are documented"

      - name: üí¨ Comment with validation summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const summary = `## üìñ Type & Documentation Validation

            ‚úÖ JSDoc analysis completed
            ‚úÖ Type annotation audit completed
            ‚úÖ Documentation completeness checked

            **Action Items:**
            - Review JSDoc coverage report
            - Ensure all public functions have @param/@returns
            - Add missing @typedef for complex types
            - Verify documentation is up-to-date

            **Best Practices:**
            - Use JSDoc for all public functions
            - Document parameters and return types
            - Use @typedef for complex object structures
            - Add examples for complex functions
            - Keep documentation in sync with code

            üìÅ See artifacts for detailed reports`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
        continue-on-error: true
