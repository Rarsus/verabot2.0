name: Documentation - Links, Format, Breaking Changes

on:
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - '**/*.md'
      - '.github/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  markdown-lint:
    name: "Markdown Linting"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¯ Run Markdownlint
        id: markdown
        continue-on-error: true
        run: |
          # Install markdown linter
          npm install -g markdownlint-cli 2>/dev/null || npm install -g markdownlint
          
          # Run linting
          markdownlint 'docs/**/*.md' '*.md' --json > markdown-report.json 2>&1 || true
          
          # Count errors
          ERROR_COUNT=$(grep -o '"error"' markdown-report.json | wc -l || echo "0")
          echo "errors=${ERROR_COUNT}" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Post markdown lint results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const errors = '${{ steps.markdown.outputs.errors }}' || '0';
            
            let summary = '## ğŸ“ Markdown Lint Report\n\n';
            
            const errorNum = parseInt(errors);
            
            if (errorNum > 0) {
              summary += `âš ï¸ **Found ${errors} markdown formatting issue(s)**\n\n`;
              summary += 'Common issues:\n';
              summary += '- Proper heading hierarchy (H1, H2, H3...)\n';
              summary += '- Consistent list formatting\n';
              summary += '- Code block language specification\n';
              summary += '- Line length and spacing\n\n';
              summary += 'Run `markdownlint` locally to fix:\n';
              summary += '```bash\n';
              summary += 'npm install -g markdownlint-cli\n';
              summary += 'markdownlint docs/**/*.md *.md\n';
              summary += '```\n';
            } else {
              summary += 'âœ… **All markdown files properly formatted**\n\n';
            }
            
            core.notice(summary);

  link-check:
    name: "Link Validation"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”— Check markdown links
        id: links
        continue-on-error: true
        run: |
          # Install markdown link checker
          npm install -g markdown-link-check 2>/dev/null
          
          # Check all markdown files
          BROKEN_LINKS=0
          for file in $(find docs -name "*.md" -o name "*.md" | grep -E "\.md$"); do
            markdown-link-check -q "$file" || ((BROKEN_LINKS++))
          done
          
          echo "broken_links=${BROKEN_LINKS}" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Post link check results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const brokenLinks = '${{ steps.links.outputs.broken_links }}' || '0';
            
            let summary = '## ğŸ”— Link Validation Report\n\n';
            
            const brokenNum = parseInt(brokenLinks);
            
            if (brokenNum > 0) {
              summary += `âš ï¸ **Found ${brokenLinks} file(s) with broken links**\n\n`;
              summary += 'Issues to check:\n';
              summary += '- Relative path links point to existing files\n';
              summary += '- External links are still valid\n';
              summary += '- Anchor references (#section) are correct\n';
            } else {
              summary += 'âœ… **All links validated successfully**\n\n';
            }
            
            core.notice(summary);

  breaking-changes:
    name: "Breaking Change Detection"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸš¨ Check for breaking changes
        id: breaking
        continue-on-error: true
        run: |
          # Get PR title and description
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          FULL_TEXT="${PR_TITLE}\n${PR_BODY}"
          
          # Check for breaking change keywords
          if echo -e "$FULL_TEXT" | grep -iE "BREAKING|breaking change|!:|migration required"; then
            echo "found=true" >> $GITHUB_OUTPUT
            
            # Check if migration guide exists
            if grep -r "migration\|MIGRATION" docs/ --include="*.md" > /dev/null 2>&1; then
              echo "has_guide=true" >> $GITHUB_OUTPUT
            else
              echo "has_guide=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Post breaking change check
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const foundBreaking = '${{ steps.breaking.outputs.found }}' === 'true';
            const hasGuide = '${{ steps.breaking.outputs.has_guide }}' === 'true';
            
            if (!foundBreaking) {
              core.notice('âœ… No breaking changes detected');
              return;
            }
            
            let summary = '## ğŸš¨ Breaking Change Detected\n\n';
            
            if (hasGuide) {
              summary += 'âœ… **Migration guide found in documentation**\n\n';
              summary += 'Ensure:\n';
              summary += '- Migration path is clear\n';
              summary += '- Deprecation timeline is specified\n';
              summary += '- Upgrade steps are documented\n';
            } else {
              summary += 'âŒ **No migration guide found**\n\n';
              summary += 'Please add a migration guide to:\n';
              summary += '- Explain the breaking change\n';
              summary += '- Provide upgrade path\n';
              summary += '- Include code examples\n';
              summary += '- Specify deprecation timeline\n\n';
              summary += 'Suggested location: `docs/guides/migration-{version}.md`\n';
            }
            
            core.setFailed('Breaking change requires migration guide');

  documentation-naming:
    name: "Documentation Naming Convention"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“‹ Check documentation naming
        id: naming
        continue-on-error: true
        run: |
          # Check for improperly named documentation files
          VIOLATIONS=0
          
          # Root level docs should be UPPERCASE
          for file in *.md; do
            [ "$file" = "README.md" ] && continue
            if ! echo "$file" | grep -qE '^[A-Z][A-Z0-9_-]*\.md$'; then
              echo "Warning: Root doc $file should follow UPPERCASE-NAMING.md convention"
              ((VIOLATIONS++))
            fi
          done
          
          # Check phase documents
          for file in PHASE-*.md; do
            [ ! -f "$file" ] && continue
            if ! echo "$file" | grep -qE '^PHASE-[0-9]+(\.[0-9]+)?[a-z]?-[A-Z][A-Z0-9_-]*\.md$'; then
              echo "Warning: Phase doc $file should follow PHASE-{#}.{section}-{TYPE}.md"
              ((VIOLATIONS++))
            fi
          done
          
          echo "violations=${VIOLATIONS}" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Post naming convention check
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const violations = '${{ steps.naming.outputs.violations }}' || '0';
            
            let summary = '## ğŸ“ Documentation Naming Convention\n\n';
            
            const violationNum = parseInt(violations);
            
            if (violationNum > 0) {
              summary += `âš ï¸ **Found ${violations} naming violation(s)**\n\n`;
              summary += 'Reference: [DOCUMENT-NAMING-CONVENTION.md](DOCUMENT-NAMING-CONVENTION.md)\n\n';
              summary += 'Naming rules:\n';
              summary += '- Root docs: `UPPERCASE-WITH-HYPHENS.md` (e.g., `README.md`, `CONTRIBUTING.md`)\n';
              summary += '- Phase docs: `PHASE-{#}.{section}-{TYPE}.md` (e.g., `PHASE-22.3-COVERAGE-EXPANSION-PLAN.md`)\n';
              summary += '- Subdirs: `lowercase-with-hyphens.md` (e.g., `docs/guides/testing-guide.md`)\n';
            } else {
              summary += 'âœ… **All documentation follows naming convention**\n\n';
            }
            
            core.notice(summary);

  documentation-summary:
    name: "Documentation Summary"
    runs-on: ubuntu-latest
    needs: [markdown-lint, link-check, breaking-changes, documentation-naming]
    if: always()

    steps:
      - name: ğŸ“‹ Generate documentation summary
        uses: actions/github-script@v7
        with:
          script: |
            const markdownResult = '${{ needs.markdown-lint.result }}';
            const linkResult = '${{ needs.link-check.result }}';
            const breakingResult = '${{ needs.breaking-changes.result }}';
            const namingResult = '${{ needs.documentation-naming.result }}';
            
            const allPassed = [markdownResult, linkResult, breakingResult, namingResult]
              .every(r => r === 'success' || r === 'skipped');
            
            let summary = '## ğŸ“š Documentation Validation Summary\n\n';
            summary += `${markdownResult === 'success' ? 'âœ…' : 'âŒ'} Markdown Linting\n`;
            summary += `${linkResult === 'success' ? 'âœ…' : 'âŒ'} Link Validation\n`;
            summary += `${breakingResult === 'success' ? 'âœ…' : 'âŒ'} Breaking Changes\n`;
            summary += `${namingResult === 'success' ? 'âœ…' : 'âŒ'} Naming Convention\n`;
            summary += '\n';
            
            if (allPassed) {
              core.notice('âœ… All documentation checks passed');
            } else {
              core.notice('âš ï¸ Some documentation checks need attention - see details above');
            }
