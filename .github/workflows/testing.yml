name: Testing - Unit & Integration

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  unit-tests-node20:
    name: "Unit Tests (Node 20.x)"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ§ª Run unit tests
        id: test
        run: |
          npm run test:quick -- \
            --coverage \
            --collectCoverageFrom='src/**/*.js' \
            --collectCoverageFrom='!src/**/*.test.js' \
            --json \
            --outputFile=test-results-node20.json \
            2>&1 | tee test-output-node20.txt
          
          TEST_EXIT_CODE=$?
          echo "exit_code=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT
          
          # Extract test counts
          PASS_COUNT=$(grep -oP '\d+(?= passed)' test-output-node20.txt | head -1 || echo "0")
          FAIL_COUNT=$(grep -oP '\d+(?= failed)' test-output-node20.txt | head -1 || echo "0")
          echo "passed=${PASS_COUNT}" >> $GITHUB_OUTPUT
          echo "failed=${FAIL_COUNT}" >> $GITHUB_OUTPUT
          
          exit 0  # Don't fail, we'll handle it below

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests-node20
          name: unit-tests-node20
          fail_ci_if_error: false

      - name: âŒ Fail if tests failed
        if: steps.test.outputs.exit_code != 0
        run: exit 1

  unit-tests-node22:
    name: "Unit Tests (Node 22.x)"
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ§ª Run unit tests
        id: test
        run: |
          npm run test:quick -- \
            --coverage \
            --collectCoverageFrom='src/**/*.js' \
            --collectCoverageFrom='!src/**/*.test.js' \
            --json \
            --outputFile=test-results-node22.json \
            2>&1 | tee test-output-node22.txt
          
          TEST_EXIT_CODE=$?
          echo "exit_code=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT
          
          # Extract test counts
          PASS_COUNT=$(grep -oP '\d+(?= passed)' test-output-node22.txt | head -1 || echo "0")
          FAIL_COUNT=$(grep -oP '\d+(?= failed)' test-output-node22.txt | head -1 || echo "0")
          echo "passed=${PASS_COUNT}" >> $GITHUB_OUTPUT
          echo "failed=${FAIL_COUNT}" >> $GITHUB_OUTPUT
          
          exit 0

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests-node22
          name: unit-tests-node22
          fail_ci_if_error: false

      - name: âŒ Fail if tests failed
        if: steps.test.outputs.exit_code != 0
        run: exit 1

  integration-tests:
    name: "Integration Tests"
    runs-on: ubuntu-latest
    needs: [unit-tests-node20, unit-tests-node22]
    if: always() && needs.unit-tests-node20.result != 'failure' && needs.unit-tests-node22.result != 'failure'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ§ª Run integration tests
        id: test
        run: |
          npm run test:integration -- \
            --coverage \
            --collectCoverageFrom='src/**/*.js' \
            --collectCoverageFrom='!src/**/*.test.js' \
            --json \
            --outputFile=test-results-integration.json \
            2>&1 | tee test-output-integration.txt
          
          TEST_EXIT_CODE=$?
          echo "exit_code=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT
          
          # Extract test counts
          PASS_COUNT=$(grep -oP '\d+(?= passed)' test-output-integration.txt | head -1 || echo "0")
          FAIL_COUNT=$(grep -oP '\d+(?= failed)' test-output-integration.txt | head -1 || echo "0")
          echo "passed=${PASS_COUNT}" >> $GITHUB_OUTPUT
          echo "failed=${FAIL_COUNT}" >> $GITHUB_OUTPUT
          
          exit 0

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: integration
          name: integration-tests
          fail_ci_if_error: false

      - name: âŒ Fail if tests failed
        if: steps.test.outputs.exit_code != 0
        run: exit 1

  coverage-validation:
    name: "Coverage Thresholds"
    runs-on: ubuntu-latest
    needs: [unit-tests-node20, unit-tests-node22, integration-tests]
    if: always()

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ“Š Generate coverage report
        id: coverage
        run: |
          npm run test:quick -- --coverage --silent 2>&1
          npm run coverage:report 2>&1 | tee coverage-report.txt
          
          # Extract coverage numbers
          LINES=$(grep -oP 'Lines\s+:\s+\K[\d.]+' coverage-report.txt | head -1 || echo "0")
          FUNCTIONS=$(grep -oP 'Functions\s+:\s+\K[\d.]+' coverage-report.txt | head -1 || echo "0")
          BRANCHES=$(grep -oP 'Branches\s+:\s+\K[\d.]+' coverage-report.txt | head -1 || echo "0")
          
          echo "lines=${LINES}" >> $GITHUB_OUTPUT
          echo "functions=${FUNCTIONS}" >> $GITHUB_OUTPUT
          echo "branches=${BRANCHES}" >> $GITHUB_OUTPUT

      - name: ğŸ¯ Validate coverage thresholds
        uses: actions/github-script@v7
        with:
          script: |
            const lines = parseFloat('${{ steps.coverage.outputs.lines }}') || 0;
            const functions = parseFloat('${{ steps.coverage.outputs.functions }}') || 0;
            const branches = parseFloat('${{ steps.coverage.outputs.branches }}') || 0;
            
            // Baseline thresholds (Jan 2026): Current coverage becomes minimum
            // As coverage improves, these baselines increase (no regression allowed)
            const MIN_LINES = 79.5;
            const MIN_FUNCTIONS = 82.7;
            const MIN_BRANCHES = 74.7;
            
            // Target thresholds: Goal for continuous improvement
            const TARGET_LINES = 90;
            const TARGET_FUNCTIONS = 95;
            const TARGET_BRANCHES = 85;
            
            let message = '## ğŸ“Š Coverage Report\n\n';
            message += '| Metric | Coverage | Minimum | Target | Status |\n';
            message += '|--------|----------|---------|--------|--------|\n';
            
            let hasCritical = false;
            let hasWarning = false;
            
            // Lines
            let linesStatus = 'âŒ Critical';
            if (lines >= MIN_LINES) {
              linesStatus = lines >= TARGET_LINES ? 'âœ… Target' : 'âš ï¸ Acceptable';
              if (lines < TARGET_LINES) hasWarning = true;
            } else {
              hasCritical = true;
            }
            message += `| Lines | ${lines.toFixed(1)}% | ${MIN_LINES}% | ${TARGET_LINES}% | ${linesStatus} |\n`;
            
            // Functions
            let functionsStatus = 'âŒ Critical';
            if (functions >= MIN_FUNCTIONS) {
              functionsStatus = functions >= TARGET_FUNCTIONS ? 'âœ… Target' : 'âš ï¸ Acceptable';
              if (functions < TARGET_FUNCTIONS) hasWarning = true;
            } else {
              hasCritical = true;
            }
            message += `| Functions | ${functions.toFixed(1)}% | ${MIN_FUNCTIONS}% | ${TARGET_FUNCTIONS}% | ${functionsStatus} |\n`;
            
            // Branches
            let branchesStatus = 'âŒ Critical';
            if (branches >= MIN_BRANCHES) {
              branchesStatus = branches >= TARGET_BRANCHES ? 'âœ… Target' : 'âš ï¸ Acceptable';
              if (branches < TARGET_BRANCHES) hasWarning = true;
            } else {
              hasCritical = true;
            }
            message += `| Branches | ${branches.toFixed(1)}% | ${MIN_BRANCHES}% | ${TARGET_BRANCHES}% | ${branchesStatus} |\n`;
            
            message += '\n';
            
            if (hasCritical) {
              message += 'âŒ **Coverage below minimum thresholds**\n\n';
              message += 'Add more tests to reach minimum coverage:\n';
              message += `- Lines: need ${(MIN_LINES - lines).toFixed(1)}% more\n`;
              message += `- Functions: need ${(MIN_FUNCTIONS - functions).toFixed(1)}% more\n`;
              message += `- Branches: need ${(MIN_BRANCHES - branches).toFixed(1)}% more\n`;
            } else if (hasWarning) {
              message += 'âš ï¸ **Coverage above minimum but below target**\n\n';
              message += 'Consider adding tests to reach target coverage (recommended).\n';
            } else {
              message += 'âœ… **Coverage meets or exceeds all thresholds**\n\n';
              message += 'Great job! Coverage goals achieved.\n';
            }
            
            core.notice(message);
            
            if (hasCritical) {
              core.setFailed('Coverage below minimum thresholds');
            }

      - name: ğŸ“ˆ Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage-report.txt
          retention-days: 7

  test-summary:
    name: "Test Summary"
    runs-on: ubuntu-latest
    needs: [unit-tests-node20, unit-tests-node22, integration-tests, coverage-validation]
    if: always()

    steps:
      - name: ğŸ“‹ Create test summary
        uses: actions/github-script@v7
        with:
          script: |
            const unit20Result = '${{ needs.unit-tests-node20.result }}';
            const unit22Result = '${{ needs.unit-tests-node22.result }}';
            const integrationResult = '${{ needs.integration-tests.result }}';
            const coverageResult = '${{ needs.coverage-validation.result }}';
            
            const allPassed = [unit20Result, unit22Result, integrationResult, coverageResult]
              .every(r => r === 'success' || r === 'skipped');
            
            let summary = '## ğŸ§ª Test Execution Summary\n\n';
            summary += `${unit20Result === 'success' ? 'âœ…' : 'âŒ'} Unit Tests (Node 20)\n`;
            summary += `${unit22Result === 'success' ? 'âœ…' : 'âŒ'} Unit Tests (Node 22)\n`;
            summary += `${integrationResult === 'success' ? 'âœ…' : 'âŒ'} Integration Tests\n`;
            summary += `${coverageResult === 'success' ? 'âœ…' : 'âŒ'} Coverage Validation\n`;
            
            if (allPassed) {
              core.notice('âœ… All tests passed!');
            } else {
              core.setFailed('Some tests failed');
            }

      - name: âŒ Fail workflow if tests failed
        if: |
          needs.unit-tests-node20.result == 'failure' ||
          needs.unit-tests-node22.result == 'failure' ||
          needs.integration-tests.result == 'failure' ||
          needs.coverage-validation.result == 'failure'
        run: exit 1
